    \documentclass[11pt,
        usenames, % allows access to some tikz colors
        dvipsnames % more colors: https://en.wikibooks.org/wiki/LaTeX/Colors
    ]{article}
    \usepackage{
        amsmath,
        amssymb,
        fouriernc, % fourier font w/ new century book
        fancyhdr, % page styling
        lastpage, % footer fanciness
        hyperref, % various links
        setspace, % line spacing
        amsthm, % newtheorem and proof environment
        mathtools, % \Aboxed for boxing inside aligns, among others
        float, % Allow [H] figure env alignment
        enumerate, % Allow custom enumerate numbering
        graphicx, % allow includegraphics with more filetypes
        wasysym, % \smiley!
        upgreek, % \upmu for \mum macro
        listings, % writing TrueType fonts and including code prettily
        tikz, % drawing things
        booktabs, % \bottomrule instead of hline apparently
        cancel % can cancel things out!
    }
    \usepackage[margin=1in]{geometry} % page geometry
    \usepackage[
        labelfont=bf, % caption names are labeled in bold
        font=scriptsize % smaller font for captions
    ]{caption}
    \usepackage[font=scriptsize]{subcaption} % subfigures

    \newcommand*{\scinot}[2]{#1\times10^{#2}}
    \newcommand*{\dotp}[2]{\left<#1\,\middle|\,#2\right>}
    \newcommand*{\rd}[2]{\frac{\mathrm{d}#1}{\mathrm{d}#2}}
    \newcommand*{\pd}[2]{\frac{\partial#1}{\partial#2}}
    \newcommand*{\rtd}[2]{\frac{\mathrm{d}^2#1}{\mathrm{d}#2^2}}
    \newcommand*{\ptd}[2]{\frac{\partial^2 #1}{\partial#2^2}}
    \newcommand*{\md}[2]{\frac{\mathrm{D}#1}{\mathrm{D}#2}}
    \newcommand*{\pvec}[1]{\vec{#1}^{\,\prime}}
    \newcommand*{\svec}[1]{\vec{#1}\;\!}
    \newcommand*{\bm}[1]{\boldsymbol{\mathbf{#1}}}
    \newcommand*{\ang}[0]{\;\text{\AA}}
    \newcommand*{\mum}[0]{\;\upmu \mathrm{m}}
    \newcommand*{\at}[1]{\left.#1\right|}

    \newtheorem{theorem}{Theorem}[section]

    \let\Re\undefined
    \let\Im\undefined
    \DeclareMathOperator{\Res}{Res}
    \DeclareMathOperator{\Re}{Re}
    \DeclareMathOperator{\Im}{Im}
    \DeclareMathOperator{\Log}{Log}
    \DeclareMathOperator{\Arg}{Arg}
    \DeclareMathOperator{\Tr}{Tr}
    \DeclareMathOperator{\E}{E}
    \DeclareMathOperator{\Var}{Var}
    \DeclareMathOperator*{\argmin}{argmin}
    \DeclareMathOperator*{\argmax}{argmax}
    \DeclareMathOperator{\sgn}{sgn}
    \DeclareMathOperator{\diag}{diag\;}

    \DeclarePairedDelimiter\bra{\langle}{\rvert}
    \DeclarePairedDelimiter\ket{\lvert}{\rangle}
    \DeclarePairedDelimiter\abs{\lvert}{\rvert}
    \DeclarePairedDelimiter\ev{\langle}{\rangle}
    \DeclarePairedDelimiter\p{\lparen}{\rparen}
    \DeclarePairedDelimiter\s{\lbrack}{\rbrack}
    \DeclarePairedDelimiter\z{\lbrace}{\rbrace}

    % \everymath{\displaystyle} % biggify limits of inline sums and integrals
    \tikzstyle{circ} % usage: \node[circ, placement] (label) {text};
        = [draw, circle, fill=white, node distance=3cm, minimum height=2em]
    \definecolor{commentgreen}{rgb}{0,0.6,0}
    \lstset{
        basicstyle=\ttfamily\footnotesize,
        frame=single,
        numbers=left,
        showstringspaces=false,
        keywordstyle=\color{blue},
        stringstyle=\color{purple},
        commentstyle=\color{commentgreen},
        morecomment=[l][\color{magenta}]{\#}
    }

\begin{document}

\def\Snospace~{\S{}} % hack to remove the space left after autorefs
\renewcommand*{\sectionautorefname}{\Snospace}
\renewcommand*{\appendixautorefname}{\Snospace}
\renewcommand*{\figureautorefname}{Fig.}
\renewcommand*{\equationautorefname}{Eq.}
\renewcommand*{\tableautorefname}{Tab.}

\section{Hamiltonians and EOM}

\subsection{Toy Problem}

Consider simplest spin Hamiltonian $H = -\vec{B} \cdot \vec{s}$. It's clear that
if we set up initial conditions $\vec{s}$ misaligned from $\vec{B}$, it will
simply spin around $\vec{B}$, which is fixed. Thus, let $\hat{B} \cdot \hat{s} =
\cos \theta$ the angle between the two, and let $\phi$ measure the azimuthal
angle.

We claim that $\cos \theta, \phi$ are canonical variables. Since $\phi$ is
ignorable, immediately $\rd{\theta}{t} = \rd{\cos \theta}{t} = -\pd{H}{\phi} =
0$, while $\rd{\phi}{t} = \pd{H}{(\cos \theta)} = Bs$ tells us the rate at which
the spin precesses around $\vec{B}$.

\subsection{Cassini State Hamilttonian}

This Hamiltonian is Kassandras Eq.\ 13, in the co-rotating frame with the
perturber's angular momentum:
\begin{equation}
    \mathcal{H} = \frac{1}{2}\p*{\hat{s} \cdot \hat{l}}^2
        - \eta \p*{\hat{s} \cdot \hat{l}_p}.
\end{equation}
In this frame, we can choose $\hat{l} \equiv \hat{z}$ fixed, and $\hat{l}_p =
\cos I\hat{z} + \sin I\hat{x}$ fixed as well. Then
\begin{equation*}
    \hat{s} = \cos\theta \hat{z}
        - \sin\theta\p*{\sin \phi \hat{y} + \cos \phi \hat{x}}.
\end{equation*}
We can choose the convention for $\phi = \phi$ azimuthal angle requiring $\phi =
0, \pi$ mean coplanarity between $\hat{s}, \hat{l}, \hat{l}_p$ in the $\hat{x},
\hat{z}$ plane such that $\hat{l}_p, \hat{s}$ lie on the same side of
$\hat{l}$. Then we can evaluate in coordinates
\begin{align*}
    \hat{s} \cdot \hat{l} &= \cos \theta,\\
    \hat{s} \cdot \hat{l}_p
        &= \cos \theta \cos I - \sin I \sin \theta \cos \phi,\\
    \mathcal{H} &= -\frac{1}{2}\cos^2\theta
        + \eta \p*{\cos \theta \cos I - \sin I \sin \theta \cos \phi}.
\end{align*}
Note that if we take $\cos\theta$ to be our canonical variable, $\sin\theta =
\sqrt{1 - \cos^2\theta}$ can be used.

\subsection{Equation of Motion}

The correct EOM comes from Kassandra's Eq.\ 12:
\begin{align*}
    \rd{\hat{s}}{t} &=
        \p*{\hat{s} \cdot \hat{l}}\p*{\hat{s} \times \hat{l}}
            -\eta\p*{\hat{s} \times \hat{l}_p},\\
        &= \p*{s_ys_z - \eta s_y\cos(I)}\hat{x}
            - \p*{s_xs_z + \eta \p*{s_x\cos I - s_z\sin I}}\hat{y}
            + \eta s_y \sin(I)\hat{z}.
\end{align*}

Alternatively, consider Hamilton's equations applied to the Hamiltonian:
\begin{align}
    \pd{\phi}{t} = \pd{\mathcal{H}}{(\cos\theta)}
        &= -\cos\theta + \eta\p*{\cos I + \sin I \cot \theta \cos \phi},\\
    \pd{(\cos \theta)}{t} = -\pd{\mathcal{H}}{\phi}
        &= -\eta \sin I \sin \theta \sin \phi.\label{eq:H_eom}
\end{align}
This produces the same trajectories as the Cartesian EOM, so this is correct.
However, since $\pd{\phi}{t} \propto 1/\sin\theta$, this is not a desirable
system of equations to use, as they are very stiff near $\theta \approx 0$.

\subsection{Cassini States}

The zeros to \autoref{eq:H_eom} are the Cassini states; we will go to canonical
variables $\mu = \cos\theta$. We can immediately see that $\sin\phi = 0$ is
necessary, so $\cos \phi = \pm 1$ and we need only solve for $\pd{\phi}{t} = 0$.
We can furthermore separate the problem into two regimes, $\eta \ll 1$ and $\eta
\gg 1$.

For $\eta \ll 1$, it is clear that there will be two solutions near $\mu^2 = 1$
and two solutions near $\mu = 0$:
\begin{itemize}
    \item For $\mu = 1 - \frac{\theta^2}{2}$, the dominant terms are
        $\pd{\phi}{t} \approx -1 + \eta \sin I \frac{1}{\theta} = 0$,
        where we've taken $\cos \phi = +1$ and $\phi = 0$. This forces $\theta
        = \eta \sin I$.

    \item Similarly, for $\mu = -1 + \frac{\epsilon^2}{2}$, $\phi = 0$ and
        $\epsilon = \eta \sin I$ again. This actually corresponds to $\theta =
        \pi - \eta \sin I$.

    \item For $\mu \approx 0$, we have instead $\pd{\phi}{t} = -\mu\p*{1 - \eta
        \sin I \cos \phi} + \eta \cos I = 0$. This forces $\mu_\pm = \frac{\eta
        \cos I}{1 \pm \eta \sin I}$, where $\phi_{\pm} = \pi, 0$ respectively.

        Note that $\phi = 0, \mu \approx 0$ is conventionally CS4. The
        linearization locally has form $\pd{\delta \phi}{t} = -\delta \mu\p*{1 -
        \eta \sin I}$ and $\pd{\delta \mu}{t} = -\eta \sin I \delta \phi$, so
        the eigenvalues are $\approx \mp \sqrt{\eta \sin I}$, and the two
        eigenvectors are $\p*{1, \pm \sqrt{\eta \sin I}}$.
\end{itemize}

For $\eta \gg 1$, the solutions obviously just come from $\cos I \pm \sin I \cot
\theta = 0$, which are just $\sin (I \pm \theta) = 0$

\subsection{Separatrix Area}

We can estimate the area enclosed by the separatrix, as shown in
\autoref{fig:1contours}. Note that the separatrix joins Cassini State 4 to its
$+ 2\pi$ image.
\begin{figure}[t]
    \centering
    \includegraphics[width=0.6\textwidth]{plots/1contours.png}
    \caption{Separatrix for various values of $\eta$.}\label{fig:1contours}
\end{figure}

We notate $\mu = \cos\theta$; note that CS4 is $\mu_4 \approx \frac{\eta \cos
I}{1 - \eta \sin I} \approx \eta \cos I$. Setting the Hamiltonian equal to its
value at CS4 gives
\begin{align*}
    H_4 &\equiv H\p*{\mu_4, \phi_4}
        \approx -\frac{\mu_4^2}{2} + \eta \mu_4 \cos I - \eta \sin I,\\
        &= +\eta^2\cos^2 I - \eta \sin I,\\
    H(\mu_{sep}, \phi_{sep})
        &= H_4 = -\eta \sin I \cos \phi_{sep} - \frac{\mu_{sep}^2}{2} + \eta
            \mu_{sep} \cos I + \mathcal{O}(\eta^3),\\
    0 &\approx \frac{\mu_{sep}^2}{2} - \eta \mu_{sep} \cos I
        - \eta \sin I\p*{1 - \cos \phi_{sep}} + \eta^2\cos^2I,\\
    \mu_{sep}\p*{\phi} &\approx \sqrt{2\eta \sin I\p*{1 - \cos \phi}}
        + \mathcal{O}(\eta).
\end{align*}

We can then easily compute the area enclosed by the separatrix
\begin{align}
    A_{sep} &= \int\limits_0^{2\pi}2\mu_{sep}\;\mathrm{d}\phi,\nonumber\\
        &\approx 16\sqrt{\eta \sin I}.
\end{align}
For $\eta = 0.1, I = 20^\circ$, this predicts $\frac{A_{sep}}{A_{T}} \approx
0.235$, which is pretty close to my numerically calculated $\frac{A_{sep}}{A_T}
= 0.229$.

\subsection{Tidal Dissipation}

We can add a tidal dissipation term; we write it in form
$\p*{\rd{\hat{s}}{t}}_{tide} = \epsilon \hat{s} \times \p*{\hat{l} \times
\hat{s}}$. Expanding,
\begin{align}
    \p*{\rd{\hat{s}}{t}}_{tide} &= \epsilon \p*{\hat{z} - s_z\hat{s}}
        ,\nonumber\\
        &= \epsilon \p*{-s_z s_x\hat{x} - s_zs_y\hat{y} + \p*{1 - s_z^2}
            \hat{z}}.
\end{align}
We run numerical simulations for weaker $\epsilon \ll \eta \ll 1$ and stronger
$\epsilon \lesssim \eta \ll 1$.

We can seek equilibria of the the system including tides, which requires
\begin{align*}
    0 &= s_ys_z - \eta s_y\cos I - \epsilon s_zs_x,\\
    0 &= -s_xs_z - \eta\p*{s_x \cos I - s_z \sin I} - \epsilon s_zs_y,\\
    0 &= \eta s_y\sin(I) + \epsilon \p*{1 - s_z^2}.
\end{align*}
We expect at least two equilibria, based on the simulations: one near $s_z
\approx 1$ and one $s_z \approx 0$.

For near alignment/near Cassini state $1$, $1 - s_z \sim 1 - s_{\perp}^2$, so we
can set $s_z = 1$ to first order: $s_y - \epsilon s_x - \eta s_y \cos I = -s_x -
\eta\p*{s_x \cos I - \sin I} - \epsilon s_y = \eta s_y \sin I = 0$. This can be
satisfied if we set $s_x = \tan(I) \ll 1, s_y = \mathcal{O}\p*{\epsilon s_x}$;
this coarsely corresponds to Cassini state $1$.

The other solution should be near Cassini state $2$, where $s_x \approx 1$;
dropping second order terms forces $\eta s_y + \epsilon s_z = -s_z -
\eta\p*{\cos I - s_z\sin I} = \eta s_y \sin(I) + \epsilon = 0$. This can thus be
satisfied for $s_y \approx -\frac{\epsilon}{\eta \sin(I)}$. Thus, this explains
why as $\epsilon$ is increased, we first start to get points that don't converge
to Cassini state $2$ in the absence of tides, before starting to see points that
fail to converge to Cassini state $1$.

\section{Separatrix Hopping}

Inspired by G\&H, heteroclinic orbits are topologically unstable for any nonzero
perturbation, but opened width $\sim$ perturbation parameter.

\subsection{Try 1: Qualitative}

We zoom in on Cassini State $4$, which has $\theta_4 =
-\frac{\pi}{2} + \frac{\eta \cos I}{1 - \eta \sin I}, \mu_4 = \frac{\eta \cos
I}{1 - \eta \sin I}, \phi_4 = 0$. Then, using
equations of motion
\begin{align}
    \pd{\phi}{t} &= \mu - \eta\p*{\cos I + \sin I \frac{\mu}{\sqrt{1 - \mu^2}}
        \cos \phi} ,\\
    \pd{\mu}{t} &= -\eta \sin I \sin \phi + \s*{\epsilon \p*{1 - \mu^2}},
\end{align}
we can perturbatively require $\pd{\theta}{t} = 0$ for $\epsilon \neq 0$. This
corresponds to $\eta \sin I \sin \p*{\phi_4 + \delta \phi} \approx \epsilon$, or
$\delta \phi_4 = +\frac{\epsilon}{\eta \sin I}$. This is in agreement with
Dong's result. Note that $\delta \theta_2 = -\frac{\epsilon}{\eta \sin I}$,
which I saw in my simulations.

This implies that the stable manifolds of the two saddle points, which once
overlapped with each other's unstable manifolds (creating a heteroclinic orbit)
now are offset from one another by distance $D \sim \frac{\epsilon}{\eta \sin
I}$. The question is how likely it is to thread the needle.

Consider that, very near CS4, the angle of incidence on the desired gap is
roughly $\tan \psi \approx \psi = \frac{\Delta \theta}{\Delta \phi}$. Over the
course of one orbit, $\Delta \phi$ changes by $2\pi$, while $\Delta \theta \sim
\epsilon \sin \theta T$ where $T$ is the period of an orbit. Examining the data,
$T \sim 50$, and so $\frac{\Delta \theta}{\Delta \phi} \sim \frac{2\pi}{\epsilon
(50)}$.

The effective probability of threading the opened gap between the
stable/unstable manifolds is then just $P \propto D\sin \psi \sim
\frac{2\pi}{T\p*{\eta \sin I}}$. According to later analysis, this should really
be $\frac{2\pi}{T}$. Plugging in some observational values $T \sim 50$ for $\eta
= 0.1$gives $P \propto 0.13$. In reality, I find it asymptotes to $\sim 0.08$,
so the constant of proportionality is of order unity. Not bad given the really
crappy $\psi \sim \frac{\ev*{\dot{\theta}}}{\dot{\phi}}$ argument.

\subsection{Try 2: Melnikov Distance}

We notice that the separatrix is a heteroclinic orbit, or a saddle connection,
in the dissipation free problem. Introducing dissipation breaks the saddle
connection by a distance that can be estimated with the Melnikov distance. This
is G\&H Equation 4.5.11 or something:
\begin{align}
    d(t_0) &= \frac{\epsilon M(t_0)}{\abs*{f(q^0(0))}} + \mathcal{O}(\epsilon^2)
        ,\\
    M(t_0) &= \int\limits_{-\infty}^\infty
        \s*{f \times g}_{hetero}\;\mathrm{d}t.
\end{align}

This is not a hard formula to understand; along the separatrix, motion is
dominated by $f$, but the perpendicular component adds up to contribute to a
total ``perpendicular distance away from the original separatrix'' necessary to
hit the saddle point, at least intuitively.

We evaluate the Melnikov integral $M(t_0)$ on the heteroclinic orbit. Note that
since in our problem our perturbation $g$ is time-independent, so too is the
Melnikov integral $M(t_0) = M$.

Let's apply this to the Cassini state Hamiltonian w/ dissipation. We first write
down our EOM in Melnikov form (we use canonical variables $\mu, \phi$):
\begin{align}
    \rd{\hat{s}}{t}
        &= \underbrace{
            \pd{\mathcal{H}}{\mu}\hat{\phi} - \pd{\mathcal{H}}{\phi}\hat{\mu}}_f
            + \epsilon \underbrace{\p*{1 - \mu^2}\hat{\mu}}_g.
\end{align}
Then $f \times g = f_\phi g_\mu = \pd{\mathcal{H}}{\mu}\p*{1 - \mu^2}$. We then
want to integrate this along the heteroclinic orbit. We can make change of
variables
\begin{equation}
    M = \int\limits_0^{2\pi}\pd{\mathcal{H}}{\mu}
        \p*{1 - \mu^2}\p*{\pd{\phi}{t}}^{-1}\;\mathrm{d}\phi.
\end{equation}
But thankfully, $\pd{\mathcal{H}}{\mu} = \pd{\phi}{t}$ in the absence of
dissipation, and so $M = 2\pi\p*{1 - \mu^2} \approx 2\pi\p*{1 - 2\eta \sin I}$.
Thus, the Melnikov distance at point $q^0$, a point on the heteroclinic
orbit of the unperturbed Hamiltonian, is just
\begin{equation}
    d(q^0) = \frac{2\pi \epsilon\p*{1 - 2\eta \sin I}}{\abs*{f(q^0)}}.
\end{equation}
Note that the maximum value $\abs*{f(q^0)}$, which occurs at $\phi = \pi$, is
just $f \approx \sqrt{4\eta \sin I}$.

It proves to be a bit difficult to make quantitative predictions though, since
the phase diagram is very smushed where $f$ is large, and $d$ is rather
inaccurate where $f$ is small. Let's think about a Poincar\'e map instead.

\subsection{Try 3: Poincar\'e Section}

Let's consider the Poincar\'e section every time $\phi = \phi_4$ as the
trajectory subject to tidal dissipation is moving $\theta < \theta_4 \to
\theta_4$. To provide an estimate of $\Delta \theta(\theta) = \theta_{n - 1} -
\theta_n$, this is just $\epsilon T$ where $T$ is the time elapsed between
$\theta_n, \theta_{n + 1}$, the period of the orbit. $T$ is dominated by when
$\pd{\phi}{t} \ll 1$ though, or where the orbit is close to the saddle point.

Note that $T$ is dominated by the time it spends near the saddle point. We
showed earlier that near CS4, $\pd{\phi}{t} \approx \delta \mu$ where $\delta
\mu = \mu - \mu_4$. Thus, we might surmise $\Delta \theta(\theta) \propto
\theta^{-1}$ for sufficiently small $\theta - \theta_4$. Far away, $T$ is
roughly constant and $\Delta \theta(\theta)$ is roughly constant.

What is ``far away''? Well, it probably depends on how affected our trajectory
is by the separatrix; far away from the saddle point, we go along contours of
roughly constant $\theta$, while close by we follow the separatrix pretty well.
We computed earlier that $\mu_{sep} \sim \sqrt{4\eta \sin I}$, so we might
expect $\mu > \mu_{sep}, \Delta \mu \sim C$, while $\mu < \mu_{sep}, \Delta
\mu \sim \delta \mu^{-1}$.

My $\mu > \mu_{sep}$ simulations don't seem to work very well, so I'll focus on
the $\delta \mu^{-1}$ case. In this case, define $\delta \mu_c: \Delta
\mu\p*{\delta \mu_c} = -\delta \mu_c$, i.e.\ the point that jumps immediately to
the saddle point. Furthermore, assume the inbound distribution is flat between
$\delta \mu_c, f^{-1}\p*{\delta \mu_c}$. TODO\@: empirically, $\mu_c \sim
\epsilon T$ is \emph{flat} with $\eta$, probably just because we're not getting
sufficiently close to the saddle point for the $\propto \sqrt{\eta}$ to kick in.

Then, we can compare the empirical Poincar\'e section of the points that cross
the separatrix versus the total predicted interval width $\delta \mu_c,
f^{-1}\p*{\delta \mu_c}$; this would predict $7.2\%, 18\%$. This does alright!

Now, one final way to think about this, and I think this is the important one:
consider if we are some $\delta \mu_0$ at $\phi = 0$ such that we barely hop the
separatrix; this corresponds to $P_{hop} = \frac{\delta \mu_0}{\mu_c}$. In order
for $\delta \mu_0$ to be hopping, $\delta \mu_\phi$ must be within $d_\phi
\approx \frac{2\pi \epsilon}{\mu}$ of the separatrix. We can compute the ratio
between $\delta \mu_0, \delta \mu_\phi$ by setting their Hamiltonian variations
equal:
\begin{align*}
    \delta H_0 &\approx -\mu_4 \delta \mu_0 + \eta \cos I \delta \mu_0
        \approx \eta^2 \cos I \sin I \delta \mu_0,\\
    \delta H_\phi &\approx -\sqrt{4\eta \sin I} \delta \mu_\phi,\\
    \frac{\delta \mu_\phi}{\delta \mu_0} &\propto
        \eta^{3/2}\cos I \sqrt{\sin I}.
\end{align*}
We can assemble

\end{document}

